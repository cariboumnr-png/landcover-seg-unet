# Configuration for creating cache blocks from scratch
name: dataprep

# where to skip data processing and generate blocks summary directly
skip_dataprep: ${skip.dataprep}

paths:
  # root directory for general cache artifacts
  cache: ./cache
  # Path to block scheme file (.pkl)
  blkscheme: ${.cache}/blocks_all_${..blocks.size}_${..blocks.overlap}.pkl
  # Directory where individual block NPZ files are stored
  blksdpath: ${.cache}/blocks
  # Path to save list of valid block NPZ files
  blkvalid: ${.cache}/blocks_valid_${c:${..filters.pxthres}}_${c:${..filters.watthres}}.pkl
  # Path to save label counts (all valid blocks)
  lblcountg: ${.cache}/label_count_global.json
  # Path to save label counts (training dataset)
  lblcountt: ${.cache}/label_count_training.json
  # Path to save aggregated image statistics (training dataset)
  imgstats: ${.cache}/image_stats.json
  # Path to save block scores
  blkscore: ${.cache}/scores.json
  # Path to save training blocks list
  datatrain: ${.cache}/blocks_training.pkl
  # Path to save validation blocks list
  dataval: ${.cache}/blocks_validation.pkl
  # Path to save block-level domain assignment (as csv)
  domain: ${.cache}/domain.json

inputs:
  # Source imagery (raster) input
  image: ./data/image_landsat_dem.tif
  # Source label raster or vector-derived raster
  label: ./data/label_15cls.tif
  # Label raster metadata (e.g., index, geometry, band info)
  meta: ./data/label_15cls_meta.json
  # if any domain knowledge provided
  domain:
    # raster with id via most frequent in each block
    - path: ./data/domain_ecodistrict.tif
      name: ecodist
      treat: majority
      type: int
    # raster with ids to convert via pca
    - path: ./data/domain_geology.tif
      name: geology
      treat: pca
      axes: 4 # output first n axes
      type: list

blocks:
  # Block/window size in pixels (height, width)
  size: 256
  # Overlap in pixels between neighboring blocks (y, x)
  overlap: 10
  # If true, randomly sample a subset of test blocks (implementation-specific)
  randtest: false

filters:
  # Pixel ratio threshold used to validate blocks (e.g., min non-nodata ratio)
  pxthres: 0.75
  # Water threshold (e.g., max allowed water fraction per block)
  watthres: 0.2

overwrite:
  # Overwrite the block scheme file if it exists
  scheme: false
  # Overwrite existing block caches (NPZ files) if they exist
  cache: false
  # Overwrite the list of valid block file paths
  valid: false
  # Overwrite the list of valid block file paths
  domain: false
  # Overwrite label count aggregation file
  count: false
  # Overwrite image stats aggregation file
  stats: false
  # Overwrite normalized blocks (update or recreate)
  norm: false
  # Overwrite block scoring (update or recreate)
  score: false
  # Overwrite block split between training/validation dataset
  split: false

cleanup:
  # If true, remove corrupted or unreadable NPZ files before recreating
  clean_npz: true

normalize:
  # Fields to update during normalization; leave empty to use defaults
  update_norm: []

scoring:
  # Layer to focus on
  layer: 'layer1'
  # Inverse distribution alpha
  alpha: 0.6
  # L1 weight reward beta
  beta: 0.8
  # L1 weight reward epsilon
  epsilon: 1e-12
  # classes to reward (1-based)
  reward: [3, 5]

valselect:
  # top proportion blocks to start gathering validation blocks
  toprange: 0.1
  # minimal distance between validation blocks in px
  mindist: 400
